<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="my-access">
  <template>
    <style include="shared-styles"></style>

    <style>
      .headline > .header {
        margin-top: 20px;
        margin-bottom: 5px;
      }

      /*
      #inputContainer {
        display: flex;
        flex-direction: row;
        align-content: center;
        align-items: baseline;
      }
      #inputContainer paper-spinner {
        align-self: flex-end;
      }
      */
    </style>


    <iron-ajax id="xhr" url="//fullinspector-api.azurewebsites.net/fullinspector/downloads?invoice_id=[[invoiceId]]" handleAs="json"></iron-ajax>

    <paper-material elevation="1" style="height: 260px">
      <div class="headline">
        <p class="page-title header">Access</p>
        <p>Enter your Full Inspector invoice number to receive access to this page. You can download previous and upcoming releases of Full Inspector.</p>

        <p>You can find your invoice on your Unity Asset Store purchase confirmation email sent from Unity.</p>
      </div>

      <div id="inputContainer">
        <paper-input error-message="Invalid invoice" id="invoiceId" style="display: inline-block; width: calc(100% - 100px);" label="Invoice" type="string"></paper-input>
        <paper-button id="submitButton"><span>Submit</span></paper-button>
        <paper-spinner id="spinner"></paper-spinner>
      </div>
    </paper-material>

    <paper-material hidden="[[!hasReleases]]" elevation="1">
      <div class="headline">
        <p class="page-title header">Releases</p>
        <p>Click the package you would like to download (give it 5 - 10 seconds to start downloading), then extract the zip and import either the source code or DLL build into your Unity project.</p>
      </div>

      <iron-list id="downloadsList" style="height: 300px" as="blob_name">
        <template>
          <div>
            <p><a href="//fullinspector-api.azurewebsites.net/fullinspector/download?invoice_id=[[invoiceId]]&blob_name=[[encode(blob_name)]]" download>[[blob_name]]</a></p>
          </div>
        </template>
      </iron-list>
    </paper-material>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        listeners: {
          'submitButton.tap': 'onSubmit'
        },

        is: 'my-access',

        ready: function() {
          var self = this;

          this.hasReleases = false;

          self.$.xhr.addEventListener('error', function() {
            self.$.invoiceId.invalid = true;
            self._hideSpinner();
          });
          self.$.xhr.addEventListener('response', function() {
            var downloads = self.$.xhr.lastResponse;
            downloads.sort().reverse();

            self.$.downloadsList.items = downloads;
            self.hasReleases = downloads.length > 0;

            self._hideSpinner();
          });
        },

        _showSpinner: function() {
          this.$.submitButton.hidden = true;
          this.$.spinner.hidden = false;
          this.$.spinner.active = true;
        },

        _hideSpinner: function() {
          this.$.submitButton.hidden = false;
          this.$.spinner.hidden = true;
          this.$.spinner.active = false;
        },

        onSubmit: function() {
          this.invoiceId = this.$.invoiceId.value;
          this.$.invoiceId.invalid = false;
          this.$.xhr.generateRequest();
          this._showSpinner();
        },

        encode: function(v) {
          return encodeURI(v);
        },

        properties: {
          greeting: {
            type: String,
            value: 'Welcome!',
            notify: true
          }
        }
      });
    })();
  </script>

</dom-module>
